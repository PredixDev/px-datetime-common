<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="validate.html" />
<link rel="import" href="px-datetime-imports.html" />
<link rel="import" href="px-datetime-behavior.html" />
<link rel="import" href="px-datetime-entry-cell.html" />
<link rel="import" href="../polymer-font-awesome/polymer-font-awesome.html" />
<link rel="import" href="../px-dropdown/px-dropdown.html" />


<!--
Range field component which displays a time or date and font awesome icon.

##### Usage

    <px-datetime-entry moment="{{...}}" date-or-time="Date">
    </px-datetime-entry>

-->
<dom-module id="px-datetime-entry">
  <link rel="import" type="css" href="css/px-datetime-entry.css"/>
  <template>

      <div id='wrapper' class="flex">
        <div class="flex__item--middle flex__item">
        <label class="label--inline">
          <span class="a11y dtLabel">{{dateOrTime}}</span>
          <iron-icon
            id="icon"
            class="fa fa-fw dtIcon"
            icon="[[_setIcon(dateOrTime)]]">
          </iron-icon>
        </label>
          <template is="dom-repeat" items="{{_cellFormatArray}}">
            <px-datetime-entry-cell
              id="cell{{index}}"
              class="cell"
              order='{{index}}'
              moment-obj="[[momentObj]]"
              moment-format='[[item]]'
              symbol=[[_returnSymbol(index)]]
              is-valid$={{isValid}}
              time-zone="[[timeZone]]">
            </px-datetime-entry-cell>
            <template is="dom-if" if={{_isSymbol(index)}}>
              <span
                class="dtEntrySymbol"
                symbol='{{_returnSymbol(index)}}'>{{_returnSymbol(index)}}
              </span>
            </template>
          </template>
        </div>
        <div class="flex__item--middle">
          <template is="dom-if" if="{{_showTimeZoneDropdown(showTimeZone)}}">
            <px-dropdown id="dropdown" display-value="[[_timeZoneAbbr]]" value="{{timeZone}}" class="flex__item" on-change="_dropdownChanged">
              <px-dropdown-content
                extend-dropdown="true"
                extend-dropdown-by="120"
                items="{{_getTimeZoneList()}}">
              </px-dropdown-content>
            </px-dropdown>
          </template>
          <template is="dom-if" if="{{_showTimeZoneText(showTimeZone)}}">
            <span class="u-ml--">{{_timeZoneAbbr}}</span>
          </template>
        </div>
      </div>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-datetime-entry',

    behaviors: [
      pxDatetimeBehavior,
      validate,
    ],

    properties: {
      /**
       * Date or Time icon/text
       *
       * Format is 'Date' or 'Time'
       *
       * Can only be configured statically; not data-bindable
       *
       * @property dateOrTime
       * @type string
       * @default none
       */
      dateOrTime: {
        type: String
      },
      /**
       *
       * Moment format string for the format to display/validate this field against (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       * Can only be configured statically; not data-bindable
       *
       * @private
       */
      momentFormat: {
        type: String
      },

      _editTimeout:{
        type:Object,
        value: function(){ return {} }
      },
      _cellFormatArray:{
        type: Array,
        notify: true
      },
      _symbolCharArray:{
        type: Array,
        notify: true,
        value: function(){
          return []
        }
      },
      /**
       *
       * Moment-timezone string for using a specific timezone. See
       * http://momentjs.com/timezone/docs/#/data-loading/getting-zone-names/
       *
       * if not provided tries to guess the current local
       */
      timeZone: {
        type: String,
        value: function() {
          return moment.tz.guess();
        },
        observer: '_timeZoneChanged'
      },
      /**
       *
       * Can be set to show the timezone. Can have 2 values:
       *  'dropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone
       *  'text': shows the time zone as text, non editable
       *
       */
      showTimeZone: {
        type: String,
        value: ''
      },
      /**
       *
       * abbreviated timezone string for using a specific timezone. See
       * http://momentjs.com/timezone/docs/#/data-loading/getting-zone-names/
       *
       *
       * @private
       */
      _timeZoneAbbr: {
        type: String,
        computed: '_getTimezoneAbbr(timeZone, momentObj)'
      }
    },

    listeners: {
      'entry-cell-move': '_entryCellMove',
      'cell-blured': '_handleBlur',
      'cell-validate': '_validateInput',
      'moment-changed': '_handleMoment'
    },

    ready: function(){

      this._splitFormat();
    },

    _splitFormat:function(){
      var re = /[MDYAaHhkmsSZXx]+/g;
      var reSymbol = /\W+/g;

      this._cellFormatArray = this.momentFormat.match(re);
      this._symbolCharArray = this.momentFormat.match(reSymbol);

      this.notifyPath('_cellFormatArray',this._cellFormatArray);
      this.notifyPath('_symbolCharArray',this._symbolCharArray);
    },

    _isSymbol: function(i){
      if(this._symbolCharArray === null || typeof(this._symbolCharArray[i]) === 'undefined'){
        return false
      }
      return true
    },

    _returnSymbol: function(i){
      if(this._symbolCharArray === null || typeof(this._symbolCharArray[i]) === 'undefined'){
        return ''
      }
      return this._symbolCharArray[i].split(' ').join('\xa0');
    },

    _setIcon: function(){
      if (this.dateOrTime.toLowerCase() === 'date') {
        return 'polymer-font-awesome:fa-calendar'
      } else {
        return 'polymer-font-awesome:fa-clock-o'
      }
    },

    _entryCellMove: function(evt){
      var ne = Polymer.dom(evt);
      var entryCellOrder = ne.rootTarget.order;

      if(entryCellOrder === this._cellFormatArray.length - 1 && evt.detail.dir === 1){

        this.fire('next-field');
      } else if(entryCellOrder === 0 && evt.detail.dir === -1){

        this.fire('previous-field');
      } else {
        entryCellOrder = parseInt(entryCellOrder) + evt.detail.dir;
        var elem = this.$$("#cell" + entryCellOrder);
        elem.$.dtEntry.focus();
      }
    },

    _handleBlur: function(){
      this._validateInput();
    },

    _handleMoment: function(evt){
      this.set('momentObj',evt.detail.momentObj);
    },
    _getTimezoneAbbr: function(timeZone, momentObj) {
      return moment.tz.zone(timeZone).abbr(momentObj);
    },
    _dropdownChanged: function() {
      //we need to re-set the value because the dropdown sets display value AFTER value
      this.$$('px-dropdown').displayValue = this._timeZoneAbbr;
    },
    _getTimeZoneList: function() {
      return moment.tz.names();
    },
    _timeZoneChanged: function() {
      if(this.momentObj) {
        var newMom = this.momentObj.clone().tz(this.timeZone);
        this.set('momentObj', newMom);
        //this.notifyPath('momentObj', this.momentObj);
      }
    },
    _showTimeZoneText: function(showTimeZone) {
      return showTimeZone === "text";
    },
    _showTimeZoneDropdown: function(showTimeZone) {
      return showTimeZone === "dropdown";
    }
  });
</script>
