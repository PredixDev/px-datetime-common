<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="validate.html" />
<link rel="import" href="px-datetime-imports.html" />
<!--
Range field component which displays a time or date and font awesome icon.

##### Usage

    <px-datetime-entry moment="{{...}}" date-or-time="Date">
    </px-datetime-entry>

-->
<dom-module id="px-datetime-entry">
  <link rel="import" type="css" href="css/px-datetime-entry-cell.css"/>
  <template>
    <input
      id="dtEntry"
      order='{{order}}'
      class="text-input--bare"
      on-focus="_handleFocus"
      on-blur="_handleBlur"
      on-input="_inputValueChanged"
      value="{{dtWorkingCopy}}"
      maxlength="{{maxlength}}">
    </input>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-datetime-entry',

    behaviors: [
      validate,
      Polymer.IronA11yKeysBehavior
    ],

    properties: {

      /**
       * Moment value with the date or time to display.  Will be parsed according to the moment format.  (see momentFormat property)
       */
      moment: {
        type: Object,
        observer: '_updateAndValidateWorkingCopy',
        notify: true
      },

      /**
       * Date or Time icon/text
       *
       * Format is 'Date' or 'Time'
       *
       * Can only be configured statically; not data-bindable
       *
       * @property dateOrTime
       * @type string
       * @default none
       */
      dateOrTime: {
        type: String
      },

      /**
       * (optional)
       *
       * Moment format string for the format to display/validate this field against (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       * Can only be configured statically; not data-bindable
       *
       * @default 'MM/DD/YYYY' for date or 'hh:mm:ss A' for time
       */
      momentFormat: {
        type: String
      },
      /**
       * A flag that tells us whether the Submit/Apply button is valid, and should be active.
       * @private
       */
      isSubmitButtonValid: {
        type: Boolean,
        value: true,
        notify: true
      },

      _editTimeout:{
        type:Object,
        value: function(){ return {} }
      },

      keyEventTarget: {
        type: Object,
        value: function() {
          return this.$.dtEntry1;
        }
      },
      _dtWorkingCopy:{
        type:String,
        notify: true
      }
    },

    /**
     * Key bindings for iron-a11y-keys-behavior
     * @private
     */
    keyBindings: {
      'enter' : '_onEnter',
      'esc' : '_onEsc',
      '1 2 3 4 5 6 7 8 9 0' : '_digit',
      'a p' : '_alpha',
      'down up' : '_incrementNumber',
      'left right tab' : '_moveCursor',
      ': \\ / -' : '_moveCursor',
    },

    stopKeyboardEventPropagation:true

    _updateAndValidateWorkingCopy: function() {
      this.set('dtWorkingCopy', this.moment.format(this.format));
      this.toggleClass('validation-error', false, this.$$('input'));
    },

    ready: function() {
    },

    _handleFocus: function(evt) {
      var ne = Polymer.dom(evt);
      console.log(ne);
      this.toggleClass("is-selected", true, ne.rootTarget);
    },

    _handleBlur: function(evt) {
      var ne = Polymer.dom(evt);
      this.toggleClass("is-selected", false, ne.rootTarget);
      this._validateInput();
    },
    /**
     * Listner attached to the input and sets up a timeout to trigger validation.
     *
     * @method _inputValueChanged
     */
    _inputValueChanged: function(evt){
      clearTimeout(this._editTimeout);
      this._editTimeout = setTimeout(function(){
        this._validateInput();
      }.bind(this), 500);
    },
    /**
     * When ENTER is clicked
     *
     * @method _onEnter
     */
    _onEnter:function(){
      console.log("Enter");
      this._validateInput();
      setTimeout(function(){
        if(this.isSubmitButtonValid){
          this.fire('datetime-button-clicked',{ action:true });
        }
      }.bind(this),10);
    },
    /**
     * When ESC is clicked
     *
     * @method _onEnter
     */
    _onEsc:function(){
      this.fire('datetime-button-clicked',{ action:false });
    },
    _digit: function(evt){
      var ne = Polymer.dom(evt);
      var digit;

      if (evt.detail.keyboardEvent.key !== undefined) {
        digit = evt.detail.keyboardEvent.key;
      } else if (evt.detail.keyboardEvent.keyIdentifier !== undefined) {
        digit = evt.detail.keyboardEvent.keyIdentifier;
      } else if (evt.detail.keyboardEvent.keyCode !== undefined) {
        digit = evt.detail.keyboardEvent.keyCode;
      }

      if(this.dateOrTime.toLowerCase() === 'date'){
        this._parseDate(digit);
      } else {
        this._parseTime(digit);
      }

      evt.preventDefault();
    },
    _moveCursor : function(){
      console.log("move");
    },
    _incrementNumber : function(){
      console.log('up down')
    },
    _alpha : function(){

    },
    _parseDate: function(digit){
      console.log(digit);
      //
    },

    _parseTime: function(digit){
      console.log(digit);
    }

  });
</script>
